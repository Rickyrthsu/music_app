<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMIYA - è½è¦‹ä½ è‡ªå·±</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f4f9; /* æŸ”å’ŒèƒŒæ™¯è‰² */
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 600px;
            background: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #6a1b9a; /* LUMIYA ç´«è‰² */
            margin-bottom: 0.5rem;
        }

        p.subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        /* --- å€å¡Šæ¨£å¼ --- */
        .section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #444;
        }

        /* --- 1. Emoji æŒ‰éˆ•å€ --- */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .emoji-btn {
            font-size: 2rem;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            cursor: pointer;
            padding: 10px;
            transition: all 0.2s;
        }

        .emoji-btn:hover {
            background: #e2e6ea;
            transform: translateY(-2px);
            border-color: #6a1b9a;
        }

        /* --- 2. æ—¥è¨˜è¼¸å…¥å€ --- */
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            resize: none;
            box-sizing: border-box; 
            font-family: inherit;
            font-size: 1rem;
        }

        .submit-btn {
            background-color: #6a1b9a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .submit-btn:hover {
            background-color: #4a148c;
        }

        /* --- 3. çµæœå±•ç¤ºå¡ç‰‡ (é è¨­éš±è—) --- */
        #result-card {
            display: none; /* JS æœƒæ§åˆ¶é¡¯ç¤º */
            background: #fafafa;
            border-left: 5px solid #6a1b9a;
            padding: 15px;
            border-radius: 5px;
            animation: fadeIn 0.5s;
            margin-top: 20px;
        }

        .song-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .cover-placeholder {
            width: 80px;
            height: 80px;
            background: #ddd;
            border-radius: 8px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #888;
            flex-shrink: 0;
        }

        .song-details h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }

        .song-details p {
            margin: 5px 0 0;
            color: #666;
            font-size: 1rem;
        }

        .ai-story {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            line-height: 1.6;
            color: #444;
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .ai-story::before {
            content: "âœ¨ LUMIYA æ—ç™½";
            display: block;
            font-size: 0.8rem;
            color: #6a1b9a;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .spotify-link {
            display: block;
            text-align: center;
            background: #1DB954; /* Spotify Green */
            color: white;
            text-decoration: none;
            padding: 12px;
            border-radius: 25px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .spotify-link:hover {
            transform: scale(1.02);
            background: #1ed760;
        }

        /* --- è¼‰å…¥ä¸­å‹•ç•« --- */
        .loading {
            text-align: center;
            color: #666;
            display: none;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a1b9a;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>LUMIYA</h1>
        <p class="subtitle">è½è¦‹ä½ è‡ªå·±ï¼šä½ çš„æ™ºæ…§éŸ³æ¨‚æƒ…æ„Ÿä¼´ä¾¶</p>

        <div class="section">
            <h2>ä½ åœ¨æƒ³ä»€éº¼ï¼Ÿ</h2>
            <div class="emoji-grid">
                <button class="emoji-btn" onclick="sendEmoji('ğŸ˜Š')">ğŸ˜Š</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ˜¢')">ğŸ˜¢</button>
                <button class="emoji-btn" onclick="sendEmoji('âš¡')">âš¡</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ§˜')">ğŸ§˜</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ˜¡')">ğŸ˜¡</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ¥°')">ğŸ¥°</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ˜´')">ğŸ˜´</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ¥³')">ğŸ¥³</button>
            </div>
        </div>

        <div class="section">
            <h2>æˆ–æ˜¯å¯«ä¸‹ä½ çš„å¿ƒæƒ…...</h2>
            <textarea id="diaryInput" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿå¯«ä¸‹ä¾†ï¼ŒLUMIYA æœƒå¹«ä½ åˆ†æä¸¦è¨˜éŒ„..."></textarea>
            <button class="submit-btn" onclick="sendDiary()">ç”Ÿæˆæ—¥è¨˜æ¨è–¦ä¸¦å„²å­˜</button>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>LUMIYA æ­£åœ¨è®€æ‡‚ä½ çš„å¿ƒï¼Œä¸¦ç¿»é–±å”±ç‰‡æ«ƒ...</p>
        </div>

        <div id="result-card">
            <div class="song-info">
                <div class="cover-placeholder" id="album-cover">å°é¢</div> 
                <div class="song-details">
                    <h3 id="track-name">æ­Œæ›²åç¨±</h3>
                    <p id="artist-name">æ­Œæ‰‹åç¨±</p>
                </div>
            </div>

            <div class="ai-story" id="ai-narration">
                </div>

            <a href="#" target="_blank" class="spotify-link" id="spotify-btn">åœ¨ Spotify ä¸Šè†è½</a>
        </div>
    </div>

    <script>
        // --- åŠŸèƒ½ 1: ç™¼é€ Emoji ---
        async function sendEmoji(emoji) {
            showLoading();
            console.log("æ­£åœ¨ç™¼é€ Emoji çµ¦å¾Œç«¯:", emoji);

            try {
                const response = await fetch('/api/recommend_by_emoji', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emoji: emoji }),
                });

                if (!response.ok) throw new Error('API å›æ‡‰éŒ¯èª¤');

                const data = await response.json();
                displayResult(data);

            } catch (error) {
                console.error("éŒ¯èª¤:", error);
                alert("é€£ç·šç™¼ç”Ÿå•é¡Œï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦å•Ÿå‹•ã€‚");
                hideLoading();
            }
        }

        // --- åŠŸèƒ½ 2: ç™¼é€å¿ƒæƒ…æ—¥è¨˜ ---
        async function sendDiary() {
            const text = document.getElementById('diaryInput').value;
            if(!text) return alert("è«‹å…ˆå¯«ä¸‹ä¸€é»å¿ƒæƒ…å–”ï¼");

            showLoading();
            console.log("ä½¿ç”¨è€…è¼¸å…¥æ—¥è¨˜:", text);

            try {
                const response = await fetch('/api/analyze_diary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text }),
                });

                if (!response.ok) throw new Error('API å›æ‡‰éŒ¯èª¤');

                const data = await response.json();
                console.log("æ”¶åˆ°æ—¥è¨˜æ¨è–¦:", data);
                
                // é¡¯ç¤ºçµæœ
                displayResult(data);
                
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('diaryInput').value = '';

            } catch (error) {
                console.error("éŒ¯èª¤:", error);
                alert("LUMIYA æ­£åœ¨ä¼‘æ¯ (åˆ†æå¤±æ•—)ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                hideLoading();
            }
        }

        // --- UI è¼”åŠ©å‡½å¼ ---
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result-card').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function displayResult(data) {
            hideLoading();
            const card = document.getElementById('result-card');
            card.style.display = 'block';
            
            // æ›´æ–°æ–‡å­—å…§å®¹
            document.getElementById('track-name').innerText = data.track_name;
            document.getElementById('artist-name').innerText = data.artist_name;
            document.getElementById('ai-narration').innerText = data.story;
            
            // æ›´æ–° Spotify é€£çµ
            const spotifyBtn = document.getElementById('spotify-btn');
            if (data.spotify_url) {
                spotifyBtn.href = data.spotify_url;
                spotifyBtn.style.display = 'block'; // ç¢ºä¿æŒ‰éˆ•é¡¯ç¤º
            } else {
                spotifyBtn.style.display = 'none'; // å¦‚æœæ²’é€£çµå°±è—èµ·ä¾†
            }

            // æ›´æ–°å°é¢åœ–
            const coverDiv = document.getElementById('album-cover');
            if (data.cover_url) {
                coverDiv.style.backgroundImage = `url('${data.cover_url}')`;
                coverDiv.style.backgroundSize = 'cover';
                coverDiv.innerText = ''; 
            } else {
                coverDiv.style.background = '#ddd';
                coverDiv.innerText = 'ç„¡å°é¢';
            }
            
            // æ»¾å‹•åˆ°çµæœå€å¡Š (æ‰‹æ©Ÿé«”é©—è¼ƒå¥½)
            card.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>